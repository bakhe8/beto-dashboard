name: Lighthouse CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lhci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: npm run build

      - name: Serve built site
        run: npx http-server ./dist -p 8080 &

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: |
            http://localhost:8080/examples/betodashboard-demo/src/pages/app.html
            http://localhost:8080/examples/betodashboard-demo/src/pages/dashboard.html
          configPath: 'lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: Parse Lighthouse results
        run: node scripts/parse-lighthouse.mjs lhci

      - name: Collect engineering metrics (LH)
        run: BD_LH_PERF=$(jq -r .performance test-results/lighthouse.json) BD_LH_A11Y=$(jq -r .accessibility test-results/lighthouse.json) BD_LH_BP=$(jq -r .bestPractices test-results/lighthouse.json) BD_LH_SEO=$(jq -r .seo test-results/lighthouse.json) npm run metrics:collect

      - name: Upload engineering metrics (LH)
        uses: actions/upload-artifact@v4
        with:
          name: engineering-metrics-lh
          path: test-results/metrics.json

      - name: Validate engineering metrics (LH)
        run: node scripts/validate-metrics.mjs --expect-lh
